<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å»¢è©±è¾²æ°‘æ›† v1.25 (å®Œç¾ä¿®å¾©ç‰ˆ)</title>
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#2c3e50">
    <link rel="apple-touch-icon" href="potato.png">

    <script src="https://cdn.jsdelivr.net/npm/lunar-javascript/lunar.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        body { font-family: "Microsoft JhengHei", "Heiti TC", sans-serif; background-color: #f0f2f5; color: #333; display: flex; align-items: center; justify-content: center; min-height: 100vh; margin: 0; overflow-x: hidden; touch-action: manipulation; }
        .container { width: 340px; max-width: 90%; position: relative; padding-bottom: 50px; }
        
        .page { background: white; border-radius: 24px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); text-align: center; display: none; }
        #page-input { padding: 40px 30px; display: block; } 
        #page-result { padding: 0; background: transparent; box-shadow: none; } 
        #page-calendar { padding: 20px; } #page-fortune { padding: 30px 20px; }

        .input-group { margin-bottom: 15px; text-align: left; }
        .input-row { display: flex; gap: 10px; width: 100%; }
        .input-row input { flex: 1; min-width: 0; }
        input { width: 100%; padding: 12px; font-size: 16px; border: 2px solid #eee; border-radius: 12px; box-sizing: border-box; outline: none; text-align: center; font-family: inherit; }
        input:focus { border-color: #2c3e50; }
        .label-text { font-size: 14px; color: #666; margin-bottom: 5px; display: block; text-align: left; padding-left: 5px; font-weight: bold;}

        .relation-switch { display: flex; gap: 10px; margin-top: 5px; }
        .relation-option { flex: 1; }
        .relation-option input { display: none; }
        .relation-option label { display: block; padding: 10px; border: 2px solid #eee; border-radius: 10px; text-align: center; cursor: pointer; font-size: 14px; color: #aaa; transition: 0.2s; }
        .relation-option input:checked + label.love { border-color: #e84393; background: #fff0f6; color: #e84393; font-weight: bold; }
        .relation-option input:checked + label.hate { border-color: #2c3e50; background: #ecf0f1; color: #2c3e50; font-weight: bold; }

        .btn { background-color: #2c3e50; color: white; border: none; border-radius: 12px; padding: 15px 30px; font-size: 16px; font-weight: bold; cursor: pointer; width: 100%; margin-bottom: 10px; transition: 0.2s; }
        .btn:disabled { background-color: #95a5a6; cursor: not-allowed; opacity: 0.7; }
        .btn-fortune { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; box-shadow: 0 4px 15px rgba(118, 75, 162, 0.4); }
        .btn-secondary { background-color: #ecf0f1; color: #7f8c8d; }
        .btn-action { background-color: #e74c3c; } 
        .btn-ig { background: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%); color: white; box-shadow: 0 4px 15px rgba(220, 39, 67, 0.4); }
        .btn-info { background-color: #3498db; } .btn-outline { background: transparent; border: 2px solid #2c3e50; color: #2c3e50; }

        .result-card { background: #fffdf5; padding: 25px 20px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.15); border: 6px solid #2c3e50; position: relative; margin-bottom: 15px; text-align: center; overflow: hidden; }
        .result-card::before { content: ""; position: absolute; top: -15px; left: 50%; transform: translateX(-50%); width: 16px; height: 16px; background: #f0f2f5; border: 6px solid #2c3e50; border-radius: 50%; z-index: 2; }
        .mascot-img { width: 160px; height: 160px; object-fit: contain; margin: 5px auto; display: block; animation: fadeIn 0.5s ease-in; }
        
        .card-header { border-bottom: 2px dashed #ccc; padding-bottom: 10px; margin-bottom: 10px; }
        .card-name { font-size: 20px; font-weight: bold; color: #d35400; margin-bottom: 5px; }
        .card-date { font-size: 14px; color: #666; } .card-lunar { font-size: 14px; color: #e74c3c; margin-top: 5px; }
        .main-word { font-size: 60px; font-weight: 900; color: #2c3e50; margin: 5px 0; line-height: 1; }
        .mood-tag { display: inline-block; background: #2c3e50; color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px; margin-bottom: 5px; }
        
        .lucky-dash { display: flex; justify-content: space-around; margin: 15px 0; background: white; padding: 12px 5px; border-radius: 12px; border: 1px dashed #ccc; font-size: 12px; }
        .lucky-item { text-align: center; width: 25%; position: relative; }
        .lucky-item:not(:last-child)::after { content: ""; position: absolute; right: 0; top: 10%; height: 80%; width: 1px; background: #eee; }
        .lucky-label { color: #aaa; margin-bottom: 3px; font-size: 10px; }
        .lucky-val { font-weight: bold; font-size: 13px; color: #2c3e50; }

        .advice-text { font-size: 15px; line-height: 1.6; color: #555; margin-top: 10px; text-align: justify; padding: 15px; background: rgba(0,0,0,0.03); border-radius: 12px; min-height: 60px; }

        /* VIP é»‘é‡‘æ¨£å¼ */
        .vip-section { margin-top: 20px; position: relative; border-radius: 12px; overflow: hidden; transition: all 0.5s; }
        .vip-section.locked { border-top: 2px dashed #d4af37; padding-top: 15px; background: transparent; }
        .vip-section.unlocked-style { 
            background: linear-gradient(135deg, #232526, #414345); 
            padding: 20px; 
            color: #f1c40f; 
            border: 2px solid #f1c40f;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .vip-title { color: #d4af37; font-weight: bold; font-size: 14px; margin-bottom: 15px; display: inline-block; background: #fffdf5; padding: 2px 10px; border: 1px solid #d4af37; border-radius: 20px; z-index: 5; position: relative;}
        .vip-section.unlocked-style .vip-title { background: #000; color: #f1c40f; border-color: #f1c40f; }

        .vip-content { text-align: left; font-size: 14px; color: #444; line-height: 1.7; filter: blur(6px); user-select: none; transition: all 0.5s; opacity: 0.7; height: 150px; overflow: hidden; }
        .vip-content.unlocked { filter: blur(0); user-select: auto; opacity: 1; height: auto; overflow: visible; }
        .vip-section.unlocked-style .vip-content { color: #ecf0f1; } 

        /* æˆ°åŠ›æ¢ */
        .power-bar-container { margin-bottom: 8px; }
        .power-label { font-size: 12px; display: flex; justify-content: space-between; margin-bottom: 2px; }
        .progress-bg { background: rgba(255,255,255,0.2); height: 8px; border-radius: 4px; overflow: hidden; }
        .progress-fill { height: 100%; width: 0%; background: #f1c40f; transition: width 1.5s ease-out; }
        .score-val { color: #f1c40f; font-weight: bold; }

        .vip-lock-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10; background: rgba(255, 253, 245, 0.7); }
        .btn-unlock { background: linear-gradient(45deg, #f1c40f, #f39c12); color: white; border: none; padding: 10px 20px; border-radius: 20px; font-weight: bold; box-shadow: 0 4px 10px rgba(243, 156, 18, 0.4); cursor: pointer; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        
        .bazi-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; margin: 10px 0; background: rgba(255,255,255,0.9); padding: 8px; border-radius: 8px; border: 1px solid #eee; }
        .bazi-col { text-align: center; } .bazi-label { font-size: 10px; color: #999; } .bazi-val { font-size: 16px; font-weight: bold; color: #333; }
        .footer-note { font-size: 10px; color: #bbb; margin-top: 15px; text-align: center; letter-spacing: 1px; }

        .loading-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.98); z-index: 20; display: none; flex-direction: column; align-items: center; justify-content: center; border-radius: 24px; }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #2c3e50; border-radius: 50%; animation: spin 1s linear infinite; } @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .fortune-shaker { font-size: 80px; margin: 30px 0; cursor: pointer; display: inline-block; transition: transform 0.2s; } @keyframes shake { 0% { transform: translate(1px, 1px) rotate(0deg); } 10% { transform: translate(-1px, -2px) rotate(-1deg); } 50% { transform: translate(-1px, 2px) rotate(-1deg); } 100% { transform: translate(1px, -2px) rotate(-1deg); } } .shaking { animation: shake 0.5s; animation-iteration-count: infinite; } 
        .poem-card { background-color: #fff; border: 2px solid #2c3e50; padding: 20px; margin-top: 20px; display: none; animation: slideUp 0.5s ease-out; } @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } } 
        .poem-title { color: #c0392b; font-weight: bold; font-size: 24px; margin-bottom: 10px; border-bottom: 2px solid #c0392b; display: inline-block; padding-bottom: 5px; } .poem-content { font-size: 18px; line-height: 1.8; color: #333; margin: 15px 0; font-family: "KaiTi", "BiauKai", serif; font-weight: bold; } .poem-note { font-size: 12px; color: #888; margin-top: 10px; } 
        .cal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; } .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; text-align: center; } .cal-cell { padding: 8px 2px; border-radius: 8px; cursor: pointer; border: 1px solid transparent; } .cal-cell:hover { background-color: #f0f2f5; } .is-today { background-color: #2c3e50; color: white; } 
        #detail-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999; align-items: center; justify-content: center; } .detail-content { background: white; width: 85%; max-width: 350px; border-radius: 15px; padding: 20px; max-height: 80vh; overflow-y: auto; text-align: left; border-top: 10px solid #c0392b; } .detail-row { margin-bottom: 12px; font-size: 14px; border-bottom: 1px dashed #eee; padding-bottom: 8px; } .detail-label { font-weight: bold; color: #555; display: block; margin-bottom: 4px; } .close-btn { background: #eee; color: #555; padding: 10px; text-align: center; border-radius: 8px; cursor: pointer; margin-top: 20px; font-weight: bold; } h2 { margin-top: 0; color: #2c3e50; font-size: 22px; }
    </style>
</head>
<body>

<div class="container">
    <div id="page-input" class="page">
        <div class="date-label" id="dateDisplayInput">...</div>
        <h2>ä»Šæ—¥é‹å‹¢è¨ºæ–·</h2>
        <div class="input-group"><label class="label-text">ä½ çš„å¤§åï¼š</label><input type="text" id="userName" placeholder="è«‹è¼¸å…¥å§“å" maxlength="10"></div>
        <div class="input-group"><label class="label-text" style="color:#6c5ce7;">(é¸å¡«) å°è±¡å§“åï¼š</label><input type="text" id="targetName" placeholder="è¼¸å…¥ä½ æƒ³ç®—çš„é‚£å€‹äºº..." maxlength="10">
            <div class="relation-switch"><div class="relation-option"><input type="radio" id="rel-love" name="relation" value="love" checked><label for="rel-love" class="love">ğŸ’˜ ç®—å§»ç·£ (æ’©)</label></div><div class="relation-option"><input type="radio" id="rel-hate" name="relation" value="hate"><label for="rel-hate" class="hate">ğŸ’£ ç®—å­½ç·£ (ç½µ)</label></div></div>
        </div>
        <div class="input-group"><label class="label-text">ä½ çš„å¿ƒæƒ…ç‹€æ…‹ï¼š</label><input type="text" id="userMood" placeholder="ä¾‹ï¼šå¾ˆç…©ã€æƒ³é›¢è·" maxlength="20"></div>
        <div class="input-group"><label class="label-text">ä½ çš„ç”Ÿè¾° (ç®—å…«å­—ç”¨)ï¼š</label><div class="input-row"><input type="date" id="userBirthDate" value="1995-01-01"><input type="time" id="userBirthTime" value="12:00"></div></div>
        <button id="aiBtn" class="btn" onclick="tryAIAnalysis()">ğŸ”® éˆé­‚åˆ†æ</button>
        <button class="btn btn-fortune" onclick="goToFortune()">ğŸ€„ æ–ä¸€æ–æ±‚ç±¤</button>
        <button class="btn btn-outline" onclick="goToCalendar()">ğŸ“… æŸ¥çœ‹è¾²æ°‘æ›†</button>
    </div>

    <div id="page-result" class="page">
        <div class="loading-overlay" id="aiLoading"><div class="spinner"></div><p style="margin-top:15px; color:#2c3e50; font-weight:bold;">ğŸ¥” å»¢å»¢è–¯æ­£åœ¨é€šéˆ...</p></div>
        
        <div class="result-card" id="captureArea">
            <div class="card-header"><div class="card-name" id="resName"></div><div class="card-date" id="resDate"></div><div class="card-lunar" id="resLunar"></div></div>
            <img src="./potato.png" id="mascotImage" class="mascot-img" alt="Mascot" onerror="this.src='./potato.png';">
            <div class="main-word" id="resultWord">...</div>
            <div class="mood-tag" id="resMoodTag">...</div>
            <div id="luckyDashboard"></div>
            <div class="advice-text" id="resultAdvice"></div>
            
            <div class="vip-section locked" id="vipSection">
                <div class="vip-title">ğŸ”’ VIP å¤©æ©Ÿè©³æ‰¹</div>
                <div class="vip-content" id="vipContent">
                    <p style="font-weight:bold; color:#f1c40f; margin:10px 0 5px 0;">ğŸ“Š ä»Šæ—¥æˆ°åŠ›æŒ‡æ•¸</p>
                    <div id="powerBars"></div>

                    <p style="font-weight:bold; color:#f1c40f; margin:15px 0 5px 0;">âš¡ ä»Šæ—¥ä½œå¼Šä»£ç¢¼</p>
                    <div style="background:rgba(255,255,255,0.1); padding:10px; border-radius:8px; font-size:13px;">
                        <p id="vipCheatSheet">...</p>
                    </div>

                    <p style="font-weight:bold; color:#f1c40f; margin:15px 0 5px 0;">ğŸ”® å…«å­—å‘½ç›¤</p>
                    <div class="bazi-grid">
                        <div class="bazi-col"><div class="bazi-label">å¹´</div><div class="bazi-val" id="bazi-y"></div></div>
                        <div class="bazi-col"><div class="bazi-label">æœˆ</div><div class="bazi-val" id="bazi-m"></div></div>
                        <div class="bazi-col"><div class="bazi-label">æ—¥</div><div class="bazi-val" id="bazi-d"></div></div>
                        <div class="bazi-col"><div class="bazi-label">æ™‚</div><div class="bazi-val" id="bazi-h"></div></div>
                    </div>
                    <p id="vipLifeComment" style="margin-top:10px; font-size:12px; color:#bdc3c7;"></p>
                </div>
                <div class="vip-lock-overlay" id="vipOverlay">
                    <p style="font-size:12px; color:#555; margin-bottom:10px;">è§€çœ‹äº”ç¶­æŒ‡æ•¸ & ä½œå¼Šä»£ç¢¼</p>
                    <button class="btn-unlock" onclick="unlockVip()">ğŸ’° è§€çœ‹å»£å‘Šè§£é–</button>
                </div>
            </div>
            <div class="footer-note">â˜… å»¢è©±è¾²æ°‘æ›† Nonsense Almanac â˜…</div>
        </div>

        <button class="btn btn-info" onclick="showDetails()">ğŸ“… ç•¶æ—¥è©³æƒ…</button>
        <button class="btn btn-ig" onclick="downloadImage('ig')">ğŸ“¸ ä¸‹è¼‰é™å‹•åœ–</button>
        <button class="btn btn-action" onclick="downloadImage('full')">ğŸ’¾ ä¸‹è¼‰å¤©æ©Ÿåœ– (å®Œæ•´)</button>
        <button class="btn btn-secondary" onclick="resetApp()">ğŸ  å›é¦–é </button>
    </div>

    <div id="page-fortune" class="page"><h2 >è³½åšæ±‚ç±¤ç­’</h2><div class="fortune-shaker" id="shaker" onclick="drawFortune()">ğŸ€„</div><div id="shakingText" style="display:none; color:#d35400; font-weight:bold; margin-top:10px;">èª å¿ƒç¥ˆæ±‚ä¸­...</div><div class="poem-card" id="poemCard"><div class="poem-title" id="poemTitle"></div><div class="poem-content" id="poemContent"></div><div class="poem-note" id="poemNote"></div></div><button class="btn btn-secondary" style="margin-top:30px;" onclick="resetApp()">ğŸ  å›é¦–é </button></div>
    <div id="page-calendar" class="page"><div class="cal-header"><button class="btn-secondary" style="width:auto; margin:0;" onclick="changeMonth(-1)">â—€</button><div style="font-weight:bold" id="calTitle"></div><button class="btn-secondary" style="width:auto; margin:0;" onclick="changeMonth(1)">â–¶</button></div><div class="cal-grid" id="calendarGrid"></div><button class="btn btn-secondary" style="margin-top:20px;" onclick="resetApp()">ğŸ  å›é¦–é </button></div>
    <div id="detail-modal"><div class="detail-content"><div style="text-align:center;font-weight:bold;color:#c0392b;margin-bottom:15px;">é»ƒæ›†è©³æƒ…</div><div class="detail-row"><span class="detail-label">æ—¥æœŸ</span><span class="detail-val" id="d-date"></span></div><div class="detail-row"><span class="detail-label">å¹²æ”¯</span><span class="detail-val" id="d-ganzhi"></span></div><div class="detail-row"><span class="detail-label">å®œ</span><span class="detail-val" id="d-yi" style="color:#d35400"></span></div><div class="detail-row"><span class="detail-label">å¿Œ</span><span class="detail-val" id="d-ji" style="color:#27ae60"></span></div><div class="detail-row"><span class="detail-label">æ²–ç…</span><span class="detail-val" id="d-chong"></span></div><div class="detail-row"><span class="detail-label">è²¡ç¥</span><span class="detail-val" id="d-wealth"></span></div><div class="close-btn" onclick="closeDetails()">é—œé–‰</div></div></div>
</div>

<script>
    // ===========================================
    // âš ï¸ è«‹åœ¨é€™è£¡å¡«å…¥ä½ éƒ¨ç½²çš„ GAS ç¶²å€ (çµå°¾æ˜¯ /exec)
    const GAS_URL = "https://script.google.com/macros/s/AKfycbyoa6WVL06HPmBn-UJrfIFKX5h3-DfTDl4iigFXSv8XGTaOz7_5ahwq5uzMDzOHejdK/exec"; 
    // ===========================================

    let currentDate = new Date();
    let calendarViewDate = new Date();
    let isProcessing = false;

    // æ•¸æ“šåº«
    const almanacRules = { "é–‹å¸‚": { word: "è¡", img: "charge" }, "äº¤æ˜“": { word: "è¡", img: "charge" }, "å…¥å®…": { word: "æª", img: "party" }, "çº³é‡‡": { word: "æª", img: "party" }, "å«å¨¶": { word: "æ’©", img: "flirt" }, "è¨‚ç›Ÿ": { word: "æ’©", img: "flirt" }, "ç¥­ç¥€": { word: "é‚„", img: "pray" }, "ç¥ˆç¦": { word: "é‚„", img: "pray" }, "å‡ºè¡Œ": { word: "æºœ", img: "travel" }, "æ—…éŠ": { word: "æºœ", img: "travel" }, "å‹•åœŸ": { word: "æ‹†", img: "break" }, "ç ´å±‹": { word: "æ‹†", img: "break" }, "è§£é™¤": { word: "æ‹†", img: "break" }, "å®‰åºŠ": { word: "èºº", img: "sleep" }, "ç§»å¾™": { word: "èºº", img: "sleep" }, "æ²»ç—…": { word: "æ’", img: "heavy" }, "å®‰è‘¬": { word: "å†·", img: "freeze" }, "default": { word: "é¾œ", img: "turtle" } };
    const badDayRules = { "å‡ºè¡Œ": { word: "å¡", img: "stuck" }, "å«å¨¶": { word: "å†·", img: "freeze" }, "é–‹å¸‚": { word: "é›·", img: "shock" }, "å‹•åœŸ": { word: "åˆ¥", img: "stop" }, "æœƒè¦ªå‹": { word: "é–ƒ", img: "dodge" } };
    const imgMap = { "default": "./potato.png", "charge": "./potato_charge.png", "flirt": "./potato_flirt.png", "party": "./potato_party.png", "pray": "./potato_pray.png", "travel": "./potato_travel.png", "break": "./potato_break.png", "heavy": "./potato_heavy.png", "sleep": "./potato_sleep.png", "turtle": "./potato_turtle.png", "freeze": "./potato_freeze.png", "shock": "./potato_shock.png", "stuck": "./potato_stuck.png", "stop": "./potato_stop.png", "dodge": "./potato_dodge.png", "rich": "./potato_rich.png" };
    const poems = [ { title: "å¤§å‰å»¢", content: "ä»Šæ—¥å®œèººä¸å®œå¿™<br>è€é—†é›»è©±è€³é‚Šæ—<br>è–ªæ°´å…¥å¸³æœ€é‡è¦<br>å…¶ä»–çš†æ˜¯å¤¢ä¸€å ´", note: "è§£æ›°ï¼šèººè‘—å°±å°äº†" }, { title: "ä¸­å‰æ‡¶", content: "å·¥ä½œå †å¾—åƒåº§å±±<br>ä¸å¦‚å…ˆå»çˆ¬æ•å±±<br>å¤¢è£¡ä»€éº¼éƒ½æœ‰å¾—<br>é†’ä¾†ç¹¼çºŒæ“ºçˆ›æ”¤", note: "è§£æ›°ï¼šé€ƒé¿é›–å¯æ¥ä½†æœ‰ç”¨" }, { title: "ä¸‹ä¸‹å¿™", content: "ä»Šæ—¥è¡°ç¥åœ¨é ­é ‚<br>åƒè¬ä¸è¦çœ‹æ†§æ†¬<br>è‹¥æ˜¯ç¡¬è¦å‡ºé–€å»<br>è¨˜å¾—å¸¶æŠŠé˜²èº«é¤…", note: "è§£æ›°ï¼šä¹–ä¹–å¾…åœ¨å®¶" }, { title: "æœ«å‰é¤“", content: "äº”è‡Ÿå»Ÿè£¡é¬§ç©ºåŸ<br>æ¸›è‚¥è¨ˆç•«è¬ä¸èƒ½<br>çç å¥¶èŒ¶ä¾†ä¸€æ¯<br>å¿«æ¨‚ä¼¼ç¥ä»™ä¸‹å¡µ", note: "è§£æ›°ï¼šåƒé£½å†èªª" } ]; 
    const luckyColors = ["#e74c3c|ç†±æƒ…ç´…", "#3498db|æ†‚é¬±è—", "#f1c40f|ç™¼è²¡é»ƒ", "#2ecc71|éŸ­èœç¶ ", "#9b59b6|åŸºæƒ…ç´«", "#34495e|åŠ ç­é»‘", "#95a5a6|æ°´æ³¥ç°", "#e67e22|éå‹æ©˜"];
    const luckyDirections = ["æ±æ–¹", "è¥¿æ–¹", "å—æ–¹", "åŒ—æ–¹", "æ±åŒ—", "æ±å—", "è¥¿åŒ—", "è¥¿å—", "åºŠä¸Š", "å…¬å¸å¤–"];

    function s2t(text) { if(!text) return ""; return text.replace(/é¾™/g, "é¾").replace(/é©¬/g, "é¦¬").replace(/é¸¡/g, "é›").replace(/çŒª/g, "è±¬").replace(/ç¾Š/g, "ç¾Š").replace(/å†²/g, "æ²–").replace(/å†/g, "æ›†").replace(/ä¸‘/g, "ä¸‘").replace(/å†¬/g, "å†¬").replace(/è…Š/g, "è‡˜").replace(/é˜³/g, "é™½").replace(/é˜´/g, "é™°").replace(/ç¶/g, "ç¶").replace(/é—¨/g, "é–€").replace(/æˆ·/g, "æˆ¶"); }
    function loadUserData() { const savedName = localStorage.getItem('potato_userName'); const savedBirthDate = localStorage.getItem('potato_birthDate'); const savedBirthTime = localStorage.getItem('potato_birthTime'); const savedTarget = localStorage.getItem('potato_targetName'); if (savedName) document.getElementById('userName').value = savedName; if (savedBirthDate) document.getElementById('userBirthDate').value = savedBirthDate; if (savedBirthTime) document.getElementById('userBirthTime').value = savedBirthTime; if (savedTarget) document.getElementById('targetName').value = savedTarget; }
    function saveUserData() { localStorage.setItem('potato_userName', document.getElementById('userName').value); localStorage.setItem('potato_birthDate', document.getElementById('userBirthDate').value); localStorage.setItem('potato_birthTime', document.getElementById('userBirthTime').value); localStorage.setItem('potato_targetName', document.getElementById('targetName').value); }
    function getSeededRandom(seed) { let h = 0xdeadbeef; for(let i = 0; i < seed.length; i++) h = Math.imul(h ^ seed.charCodeAt(i), 2654435761); return ((h ^ h >>> 16) >>> 0) / 4294967296; }
    
    function calculateDailyLuck(date, zodiac) {
        const seed = `${date.getFullYear()}${date.getMonth()}${date.getDate()}-${zodiac}`;
        const rand = getSeededRandom(seed);
        const luckyNum = Math.floor(rand * 10);
        const colorIndex = Math.floor((rand * 100) % luckyColors.length);
        const [colorHex, colorName] = luckyColors[colorIndex].split('|');
        const hour = 9 + Math.floor((rand * 1000) % 10);
        const luckyTime = `${hour}:00 - ${hour+1}:00`;
        const dirIndex = Math.floor((rand * 50) % luckyDirections.length);
        const direction = luckyDirections[dirIndex];
        const scores = {
            wealth: Math.floor(getSeededRandom(seed + "wealth") * 60 + 40),
            love: Math.floor(getSeededRandom(seed + "love") * 100),
            work: Math.floor(getSeededRandom(seed + "work") * 100),
            health: Math.floor(getSeededRandom(seed + "health") * 40 + 60),
            luck: Math.floor(getSeededRandom(seed + "luck") * 100)
        };
        return { luckyNum, colorName, colorHex, luckyTime, direction, scores };
    }

    function init() { updateDateDisplay(); loadUserData(); }

    async function tryAIAnalysis() {
        if (isProcessing) return;
        if (!GAS_URL || GAS_URL.includes("xxxx")) { alert("è«‹å¡«å…¥ GAS éƒ¨ç½²ç¶²å€ï¼"); return; }

        saveUserData();
        isProcessing = true;
        const btn = document.getElementById('aiBtn');
        const originalText = btn.innerText;
        btn.disabled = true;
        let cooldown = 5;
        const timer = setInterval(() => { btn.innerText = `â³ ${cooldown}s`; cooldown--; if (cooldown < 0) { clearInterval(timer); btn.disabled = false; btn.innerText = originalText; isProcessing = false; } }, 1000);

        showPage('page-result');
        document.getElementById('aiLoading').style.display = 'flex';
        document.getElementById('vipSection').className = 'vip-section locked';
        document.getElementById('vipContent').classList.remove('unlocked');
        document.getElementById('vipOverlay').style.display = 'flex';

        try {
            const name = document.getElementById('userName').value.trim() || "å–„ç”·ä¿¡å¥³";
            const targetName = document.getElementById('targetName').value.trim();
            const relationType = document.querySelector('input[name="relation"]:checked').value;
            const mood = document.getElementById('userMood').value.trim() || "ä¸çŸ¥é“";
            const birthDateStr = document.getElementById('userBirthDate').value;
            const birthTimeStr = document.getElementById('userBirthTime').value;
            const birthDate = new Date(birthDateStr);
            const zodiac = getZodiacSign(birthDate);
            const lunar = Solar.fromDate(currentDate).getLunar();
            
            let themeData = almanacRules["default"];
            const yiList = lunar.getDayYi();
            for(let act of yiList) { if(almanacRules[act]) { themeData = almanacRules[act]; break; } }
            if (!themeData || themeData === almanacRules["default"]) { 
                const jiList = lunar.getDayJi();
                for(let act of jiList) { if(badDayRules[act]) { themeData = badDayRules[act]; break; } } 
            }
            if (!themeData) themeData = almanacRules["default"];

            const mainWord = themeData.word;
            const imgType = themeData.img;
            const luck = calculateDailyLuck(currentDate, zodiac);

            document.getElementById('resultWord').innerText = mainWord;
            document.getElementById('mascotImage').src = imgMap[imgType] || imgMap["default"];
            document.getElementById('resName').innerText = targetName ? `${name} âš”ï¸ ${targetName}` : `${name} çš„ä»Šæ—¥é‹å‹¢`;
            document.getElementById('resDate').innerText = `${currentDate.getFullYear()}.${currentDate.getMonth()+1}.${currentDate.getDate()}`;
            document.getElementById('resLunar').innerText = `è¾²æ›† ${lunar.getMonthInChinese()}æœˆ${lunar.getDayInChinese()}`;
            document.getElementById('resMoodTag').innerText = "å¿ƒæƒ…ï¼š" + mood;

            const [y, m, d] = birthDateStr.split('-').map(Number);
            const [h, min] = birthTimeStr.split(':').map(Number);
            const bazi = Solar.fromYmdHms(y, m, d, h, min, 0).getLunar().getEightChar();
            document.getElementById('bazi-y').innerText = s2t(bazi.getYear());
            document.getElementById('bazi-m').innerText = s2t(bazi.getMonth());
            document.getElementById('bazi-d').innerText = s2t(bazi.getDay());
            document.getElementById('bazi-h').innerText = s2t(bazi.getTime());
            document.getElementById('vipZodiac').innerText = zodiac;

            const categories = [{id: 'wealth', label: 'ğŸ’° è²¡é‹'}, {id: 'love', label: 'ğŸ‘ æ¡ƒèŠ±'}, {id: 'work', label: 'ğŸ’¼ ç¤¾ç•œ'}, {id: 'health', label: 'ğŸ”‹ å¥åº·'}, {id: 'luck', label: 'ğŸŒŸ è²´äºº'}];
            let barsHTML = "";
            categories.forEach(cat => {
                const score = luck.scores[cat.id];
                barsHTML += `<div class="power-bar-container"><div class="power-label"><span>${cat.label}</span><span class="score-val">${score}</span></div><div class="progress-bg"><div class="progress-fill" style="width:${score}%"></div></div></div>`;
            });
            document.getElementById('powerBars').innerHTML = barsHTML;

            const luckyHTML = `<div class="lucky-dash"><div class="lucky-item"><div class="lucky-label">å¹¸é‹è‰²</div><div class="lucky-val" style="color:${luck.colorHex}">${luck.colorName}</div></div><div class="lucky-item"><div class="lucky-label">å¹¸é‹æ•¸</div><div class="lucky-val">${luck.luckyNum}</div></div><div class="lucky-item"><div class="lucky-label">å‰æ™‚</div><div class="lucky-val">${luck.luckyTime}</div></div><div class="lucky-item"><div class="lucky-label">å‰ä½</div><div class="lucky-val">${luck.direction}</div></div></div>`;
            document.getElementById('luckyDashboard').innerHTML = luckyHTML;

            let task1Prompt = targetName 
                ? (relationType === "love" ? `ä½¿ç”¨è€… ${name} æƒ³å•èˆ‡å°è±¡ ${targetName} çš„ã€æˆ€æ„›å§»ç·£ã€‘ã€‚å¹¸é‹è‰²${luck.colorName}ã€‚è«‹åˆ¤æ–·ä»Šå¤©é©åˆå‘Šç™½ã€ç´„æœƒé‚„æ˜¯ä¿æŒè·é›¢ï¼Ÿ(èªæ°£æ›–æ˜§æ’©äºº)` : `ä½¿ç”¨è€… ${name} æƒ³å•èˆ‡å°è±¡ ${targetName} çš„ã€è·å ´/å­½ç·£/ä»‡äººé—œä¿‚ã€‘ã€‚å¹¸é‹è‰²${luck.colorName}ã€‚è«‹åˆ¤æ–·ä»Šå¤©é©åˆå—†è²ã€é–‹æˆ°é‚„æ˜¯é–ƒèº²ï¼Ÿ(èªæ°£æ¯’èˆŒè…¹é»‘)`)
                : `è«‹è§£é‡‹ç‚ºä»€éº¼åœ¨ã€Œ${mood}ã€çš„å¿ƒæƒ…ä¸‹ï¼Œä»Šå¤©æœ€é©åˆã€Œ${mainWord}ã€ã€‚(èªæ°£æ¯’èˆŒå¹½é»˜)`;

            const prompt = `
                ã€System: You are a Taiwanese fortune teller AI. Output ONLY in Traditional Chinese (Taiwan/TW).ã€‘
                
                ä»Šæ—¥è¾²æ°‘æ›†é—œéµå­—ï¼šã€${mainWord}ã€‘ã€‚
                ä½¿ç”¨è€…å¿ƒæƒ…ï¼š${mood}ã€‚
                ä½¿ç”¨è€…æ˜Ÿåº§ï¼š${zodiac}ã€‚
                å…«å­—å¹´å‘½ï¼š${s2t(bazi.getYearNaYin())}ã€‚

                ä»»å‹™ 1 (Advice): ${task1Prompt} (50å­—å…§)
                ä»»å‹™ 2 (Cheat Sheet): çµ¦å‡º 3 å€‹å…·é«”çš„ã€ä»Šæ—¥ä½œå¼Šä»£ç¢¼ã€‘ï¼Œä¾‹å¦‚ã€Œå®œï¼šå–çå¥¶ã€ã€ã€Œå¿Œï¼šå›è€é—†è¨Šæ¯ã€ã€ã€Œå¹¸é‹ç‰©ï¼šç™¼ç¥¨ã€ã€‚(ç°¡çŸ­åˆ—é»)
                ä»»å‹™ 3 (Vip Life): é‡å°é€™å€‹å…«å­—å¹´å‘½çš„å¹½é»˜äººç”Ÿè©•èªã€‚

                è«‹å›å‚³ JSON: { "advice": "...", "vip_cheat_sheet": "...", "vip_life_comment": "..." }
            `;

            // âš ï¸ å‘¼å« GAS (ä¸æ”¾ Key)
            const response = await fetch(GAS_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain' }, // é¿é–‹ CORS preflight
                body: JSON.stringify({ prompt: prompt })
            });

            if (!response.ok) throw new Error("GAS Error");
            const data = await response.json();
            
            // å¦‚æœ GAS å›å‚³ error
            if(data.error) throw new Error(data.error);

            let rawText = "";
            if(data.candidates && data.candidates[0].content){
                rawText = data.candidates[0].content.parts[0].text;
            } else {
                console.log("GAS Data:", data);
            }
            
            const jsonStr = rawText.replace(/```json/g, '').replace(/```/g, '').trim();
            const result = JSON.parse(jsonStr);

            document.getElementById('resultAdvice').innerText = result.advice;
            document.getElementById('vipCheatSheet').innerHTML = result.vip_cheat_sheet.replace(/\n/g, '<br>');
            document.getElementById('vipLifeComment').innerText = result.vip_life_comment;

        } catch (e) {
            console.warn("AI å¤±æ•—:", e);
            document.getElementById('resultAdvice').innerText = "AI ç¡è‘—äº†ï¼Œè«‹æª¢æŸ¥ GAS éƒ¨ç½²æ˜¯å¦æ­£ç¢ºã€‚";
            document.getElementById('vipCheatSheet').innerText = "å®œï¼šçœ‹é–‹ä¸€é»\nå¿Œï¼šå¤ªèªçœŸ";
        } finally {
            document.getElementById('aiLoading').style.display = 'none';
        }
    }

    function unlockVip(){
        if(confirm("ã€æ¨¡æ“¬ä»˜è²»ã€‘è§€çœ‹å»£å‘Šè§£é–é»‘é‡‘å¤©æ©Ÿï¼Ÿ")){
            document.getElementById('vipOverlay').style.display='none';
            document.getElementById('vipContent').classList.add('unlocked');
            document.getElementById('vipSection').classList.remove('locked');
            document.getElementById('vipSection').classList.add('unlocked-style');
            document.getElementById('page-result').scrollIntoView({behavior:'smooth',block:'end'});
        }
    }

    function downloadImage(mode) {
        const captureArea = document.getElementById('captureArea');
        const clone = captureArea.cloneNode(true);
        clone.style.width = "375px"; clone.style.position = "fixed"; clone.style.top = "-9999px"; clone.style.left = "0"; clone.style.height = "auto"; clone.style.overflow = "visible"; clone.style.borderRadius = "0";

        if (mode === 'ig') {
            const vipInClone = clone.querySelector('.vip-section');
            if (vipInClone) vipInClone.style.display = 'none';
            const adviceInClone = clone.querySelector('.advice-text');
            if(adviceInClone) { adviceInClone.style.fontSize = '18px'; adviceInClone.style.padding = '20px'; }
        } else {
            const vipSecInClone = clone.querySelector('.vip-section');
            const vipContentInClone = clone.querySelector('.vip-content');
            const overlayInClone = clone.querySelector('.vip-lock-overlay');
            if (vipSecInClone) { vipSecInClone.classList.remove('locked'); vipSecInClone.classList.add('unlocked-style'); }
            if (vipContentInClone) vipContentInClone.classList.add('unlocked');
            if (overlayInClone) overlayInClone.style.display = 'none';
        }

        document.body.appendChild(clone);
        setTimeout(() => {
            html2canvas(clone, { scale: 2, backgroundColor: "#fffdf5", useCORS: true }).then(canvas => {
                const link = document.createElement('a');
                link.download = mode === 'ig' ? `å»¢è©±è¾²æ°‘æ›†_Story_${new Date().getTime()}.png` : `å»¢è©±è¾²æ°‘æ›†_Full_${new Date().getTime()}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
                document.body.removeChild(clone);
            }).catch(err => { console.error(err); document.body.removeChild(clone); });
        }, 100);
    }
    
    // Helper functions
    function getZodiacSign(d){const m=d.getMonth()+1;const dy=d.getDate();if((m==1&&dy>=20)||(m==2&&dy<=18))return"æ°´ç“¶";if((m==2&&dy>=19)||(m==3&&dy<=20))return"é›™é­š";if((m==3&&dy>=21)||(m==4&&dy<=19))return"ç‰¡ç¾Š";if((m==4&&dy>=20)||(m==5&&dy<=20))return"é‡‘ç‰›";if((m==5&&dy>=21)||(m==6&&dy<=21))return"é›™å­";if((m==6&&dy>=22)||(m==7&&dy<=22))return"å·¨èŸ¹";if((m==7&&dy>=23)||(m==8&&dy<=22))return"ç…å­";if((m==8&&dy>=23)||(m==9&&dy<=22))return"è™•å¥³";if((m==9&&dy>=23)||(m==10&&dy<=23))return"å¤©ç§¤";if((m==10&&dy>=24)||(m==11&&dy<=22))return"å¤©è ";if((m==11&&dy>=23)||(m==12&&dy<=21))return"å°„æ‰‹";return"æ‘©ç¾¯";}
    function showPage(pageId) { document.querySelectorAll('.page').forEach(el => el.style.display = 'none'); document.getElementById(pageId).style.display = 'block'; }
    function updateDateDisplay() { const d = new Date(); document.getElementById('dateDisplayInput').innerText = `${d.getFullYear()}/${d.getMonth()+1}/${d.getDate()}`; }
    function goToFortune(){showPage('page-fortune');document.getElementById('poemCard').style.display='none';document.getElementById('shaker').classList.remove('shaking');document.getElementById('shakingText').style.display='none';}
    function drawFortune(){const s=document.getElementById('shaker');s.classList.add('shaking');document.getElementById('shakingText').style.display='block';document.getElementById('poemCard').style.display='none';setTimeout(()=>{s.classList.remove('shaking');document.getElementById('shakingText').style.display='none';const r=poems[Math.floor(Math.random()*poems.length)];document.getElementById('poemTitle').innerText=r.title;document.getElementById('poemContent').innerHTML=r.content;document.getElementById('poemNote').innerText=r.note;document.getElementById('poemCard').style.display='block';},1500);}
    function goToCalendar(){showPage('page-calendar');renderCalendar();}
    function changeMonth(o){calendarViewDate.setMonth(calendarViewDate.getMonth()+o);renderCalendar();}
    function renderCalendar(){const g=document.getElementById('calendarGrid');g.innerHTML="";document.getElementById('calTitle').innerText=`${calendarViewDate.getFullYear()}å¹´ ${calendarViewDate.getMonth()+1}æœˆ`;['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'].forEach(w=>{const d=document.createElement('div');d.innerText=w;d.style.fontSize="12px";g.appendChild(d)});const y=calendarViewDate.getFullYear();const m=calendarViewDate.getMonth();const f=new Date(y,m,1);const l=new Date(y,m+1,0);for(let i=0;i<f.getDay();i++)g.appendChild(document.createElement('div'));for(let d=1;d<=l.getDate();d++){const c=document.createElement('div');c.className='cal-cell';c.innerText=d;if(new Date(y,m,d).toDateString()===new Date().toDateString())c.classList.add('is-today');c.onclick=()=>{currentDate=new Date(y,m,d);showDetails()};g.appendChild(c);}}
    function resetApp(){document.getElementById('userMood').value="";document.getElementById('targetName').value="";currentDate=new Date();calendarViewDate=new Date();updateDateDisplay();showPage('page-input');document.getElementById('detail-modal').style.display='none';}
    function showDetails(){document.getElementById('detail-modal').style.display='flex';try{const l=Solar.fromDate(currentDate).getLunar();const s=(f)=>{try{return f()}catch{return"-"}};document.getElementById('d-date').innerText=`${currentDate.getFullYear()}/${currentDate.getMonth()+1}/${currentDate.getDate()}`;document.getElementById('d-ganzhi').innerText=s2t(`${l.getYearInGanZhi()}å¹´ ${l.getMonthInGanZhi()}æœˆ ${l.getDayInGanZhi()}æ—¥`);document.getElementById('d-yi').innerText=s2t(s(()=>l.getDayYi()).join(',')||"-");document.getElementById('d-ji').innerText=s2t(s(()=>l.getDayJi()).join(',')||"-");document.getElementById('d-chong').innerText=s2t(`${l.getDayChongDesc()}`);document.getElementById('d-wealth').innerText=s2t(`${l.getPositionXi()} / ${l.getPositionCai()}`);}catch{}}
    function closeDetails(){document.getElementById('detail-modal').style.display='none';}

    init();
</script>

</body>
</html>