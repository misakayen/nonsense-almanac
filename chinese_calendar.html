<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>å»¢è©±è¾²æ°‘æ›† v1.37</title>
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#2c3e50">
    <link rel="apple-touch-icon" href="potato.png">

    <script src="https://cdn.jsdelivr.net/npm/lunar-javascript/lunar.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: #f0f2f5; color: #333; display: flex; align-items: start; justify-content: center; min-height: 100vh; margin: 0; padding: 20px 10px; padding-top: env(safe-area-inset-top); box-sizing: border-box; overflow-x: hidden; touch-action: manipulation; user-select: none; -webkit-user-select: none; }
        .container { width: 100%; max-width: 480px; padding-bottom: 80px; margin: 0 auto; }
        ::-webkit-scrollbar { display: none; }
        .page { background: white; border-radius: 24px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); text-align: center; display: none; margin-bottom: 20px; }
        #page-input { padding: 40px 30px; display: block; } 
        #page-result { padding: 0; background: transparent; box-shadow: none; } 
        #page-calendar { padding: 20px; } #page-fortune { padding: 30px 20px; }
        input { width: 100%; padding: 16px; font-size: 18px; border: 2px solid #eee; border-radius: 16px; box-sizing: border-box; outline: none; text-align: center; background: #fafafa; font-weight: bold; -webkit-appearance: none; }
        input:focus { border-color: #2c3e50; background: #fff; }
        .label-text { font-size: 14px; color: #666; margin-bottom: 8px; display: block; text-align: left; padding-left: 5px; font-weight: bold;}
        .input-group { margin-bottom: 20px; text-align: left; }
        .btn { background-color: #2c3e50; color: white; border: none; border-radius: 16px; padding: 18px; font-size: 18px; font-weight: bold; cursor: pointer; width: 100%; margin-bottom: 15px; transition: transform 0.1s; display: flex; align-items: center; justify-content: center; gap: 8px; box-shadow: 0 4px 10px rgba(44, 62, 80, 0.2); }
        .btn:active { transform: scale(0.98); } 
        .btn-fortune { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); box-shadow: 0 4px 15px rgba(118, 75, 162, 0.3); }
        .btn-secondary { background-color: #ecf0f1; color: #7f8c8d; box-shadow: none; }
        .btn-action { background-color: #e74c3c; box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3); } 
        .btn-ig { background: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%); box-shadow: 0 4px 15px rgba(220, 39, 67, 0.3); }
        .btn-info { background-color: #3498db; box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3); } 
        .relation-switch { display: flex; gap: 10px; margin-top: 5px; } .relation-option { flex: 1; } .relation-option input { display: none; } .relation-option label { display: block; padding: 12px; border: 2px solid #eee; border-radius: 12px; text-align: center; font-size: 15px; color: #aaa; font-weight: bold; } .relation-option input:checked + label.love { border-color: #e84393; background: #fff0f6; color: #e84393; } .relation-option input:checked + label.hate { border-color: #2c3e50; background: #ecf0f1; color: #2c3e50; }
        .result-card { background: #fffdf5; padding: 30px 20px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); border: 4px solid #2c3e50; position: relative; margin-bottom: 20px; text-align: center; }
        .result-card::before { content: ""; position: absolute; top: -15px; left: 50%; transform: translateX(-50%); width: 20px; height: 20px; background: #f0f2f5; border: 4px solid #2c3e50; border-radius: 50%; z-index: 2; }
        .mascot-img { width: 180px; height: 180px; object-fit: contain; margin: 10px auto; display: block; animation: fadeIn 0.5s ease-in; }
        .card-header { border-bottom: 2px dashed #ccc; padding-bottom: 15px; margin-bottom: 15px; }
        .card-name { font-size: 24px; font-weight: 900; color: #d35400; margin-bottom: 5px; display: flex; align-items: center; justify-content: center; gap: 8px;}
        .zodiac-badge { font-size: 13px; background: #2c3e50; color: #fff; padding: 3px 10px; border-radius: 12px; vertical-align: middle; }
        .card-date { font-size: 14px; color: #666; } .card-lunar { font-size: 14px; color: #e74c3c; margin-top: 5px; }
        .main-word { font-size: 80px; font-weight: 900; color: #2c3e50; margin: 5px 0; line-height: 1; text-shadow: 3px 3px 0px rgba(0,0,0,0.1); }
        .mood-tag { display: inline-block; background: #2c3e50; color: white; padding: 5px 15px; border-radius: 20px; font-size: 13px; margin-bottom: 15px; }
        .lucky-dash { display: flex; justify-content: space-around; margin: 20px 0; background: white; padding: 15px 5px; border-radius: 16px; border: 1px dashed #ccc; }
        .lucky-item { text-align: center; width: 25%; position: relative; }
        .lucky-item:not(:last-child)::after { content: ""; position: absolute; right: 0; top: 10%; height: 80%; width: 1px; background: #eee; }
        .lucky-label { color: #aaa; margin-bottom: 4px; font-size: 11px; }
        .lucky-val { font-weight: bold; font-size: 15px; color: #2c3e50; }
        .advice-text { font-size: 17px; line-height: 1.7; color: #444; margin-top: 15px; text-align: justify; padding: 20px; background: rgba(0,0,0,0.03); border-radius: 16px; min-height: 60px; font-weight: 500; }
        .vip-card { display: none; background: #222; color: #f1c40f; padding: 30px 20px; border-radius: 20px; margin-bottom: 20px; box-shadow: 0 15px 40px rgba(0,0,0,0.5); border: 2px solid #f1c40f; text-align: center; animation: slideUp 0.6s ease-out; }
        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .vip-title { color: #222; background: #f1c40f; font-weight: 900; font-size: 16px; margin-bottom: 20px; display: inline-block; padding: 6px 18px; border-radius: 20px; text-transform: uppercase; letter-spacing: 1px; }
        .power-bar-container { margin-bottom: 15px; } .power-label { font-size: 14px; display: flex; justify-content: space-between; margin-bottom: 6px; color: #ecf0f1; font-weight: bold;} .progress-bg { background: rgba(255,255,255,0.15); height: 12px; border-radius: 6px; overflow: hidden; } .progress-fill { height: 100%; width: 0%; background: linear-gradient(90deg, #f1c40f, #e67e22); transition: width 1.5s ease-out; box-shadow: 0 0 10px rgba(241, 196, 15, 0.5); } .cheat-box { background: rgba(255,255,255,0.08); padding: 20px; border-radius: 16px; border: 1px solid rgba(241, 196, 15, 0.3); margin: 25px 0; text-align: left; } .cheat-text { color: #ecf0f1; font-size: 15px; line-height: 1.8; } .bazi-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin: 20px 0; background: rgba(255,255,255,0.1); padding: 15px; border-radius: 12px; } .bazi-col { text-align: center; } .bazi-label { font-size: 12px; color: #aaa; margin-bottom: 4px; } .bazi-val { font-size: 20px; font-weight: bold; color: #f1c40f; }
        
        #paywall-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; align-items: center; justify-content: center; backdrop-filter: blur(8px); }
        .paywall-content { background: white; width: 85%; max-width: 360px; border-radius: 24px; padding: 30px 20px; text-align: center; position: relative; animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .pay-icon { font-size: 60px; margin-bottom: 15px; display: block; }
        .pay-title { font-size: 24px; font-weight: 900; color: #2c3e50; margin-bottom: 10px; }
        .pay-desc { font-size: 15px; color: #666; margin-bottom: 25px; line-height: 1.5; }
        .btn-ad { background: linear-gradient(135deg, #3498db, #2980b9); width: 100%; margin-bottom: 10px; border: none; padding: 15px; border-radius: 12px; color: white; font-weight: bold; font-size: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;}
        .btn-buy { background: linear-gradient(135deg, #f1c40f, #e67e22); width: 100%; border: none; padding: 15px; border-radius: 12px; color: white; font-weight: bold; font-size: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;}
        .btn-close-pay { position: absolute; top: 15px; right: 15px; background: #eee; border-radius: 50%; width: 30px; height: 30px; border: none; font-weight: bold; color: #888; cursor: pointer; }
        .footer-note { font-size: 11px; color: #bbb; margin-top: 20px; text-align: center; letter-spacing: 1px; }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.98); z-index: 9999; display: none; flex-direction: column; align-items: center; justify-content: center; }
        .spinner { width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid #2c3e50; border-radius: 50%; animation: spin 1s linear infinite; } @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .fortune-shaker { font-size: 100px; margin: 40px 0; cursor: pointer; display: inline-block; transition: transform 0.2s; } @keyframes shake { 0% { transform: translate(1px, 1px) rotate(0deg); } 10% { transform: translate(-1px, -2px) rotate(-1deg); } 50% { transform: translate(-1px, 2px) rotate(-1deg); } 100% { transform: translate(1px, -2px) rotate(-1deg); } } .shaking { animation: shake 0.5s; animation-iteration-count: infinite; } .poem-card { background-color: #fff; border: 3px solid #2c3e50; padding: 25px; margin-top: 25px; display: none; animation: slideUp 0.5s ease-out; border-radius: 16px; } .poem-title { color: #c0392b; font-weight: bold; font-size: 28px; margin-bottom: 15px; border-bottom: 2px solid #c0392b; display: inline-block; padding-bottom: 5px; } .poem-content { font-size: 20px; line-height: 1.8; color: #333; margin: 20px 0; font-family: "KaiTi", "BiauKai", serif; font-weight: bold; } .poem-note { font-size: 14px; color: #888; margin-top: 10px; } .cal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; } .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; text-align: center; } .cal-cell { padding: 10px 2px; border-radius: 10px; cursor: pointer; border: 1px solid transparent; font-size: 16px;} .cal-cell:hover { background-color: #f0f2f5; } .is-today { background-color: #2c3e50; color: white; } #detail-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 9999; align-items: center; justify-content: center; backdrop-filter: blur(5px); } .detail-content { background: white; width: 85%; max-width: 350px; border-radius: 20px; padding: 25px; max-height: 80vh; overflow-y: auto; text-align: left; border-top: 10px solid #c0392b; box-shadow: 0 10px 40px rgba(0,0,0,0.3); } .detail-row { margin-bottom: 15px; font-size: 15px; border-bottom: 1px dashed #eee; padding-bottom: 10px; } .detail-label { font-weight: bold; color: #555; display: block; margin-bottom: 5px; } .close-btn { background: #eee; color: #555; padding: 12px; text-align: center; border-radius: 12px; cursor: pointer; margin-top: 25px; font-weight: bold; } h2 { margin-top: 0; color: #2c3e50; font-size: 24px; } .input-row input { background: #fff; }
    </style>
</head>
<body>

<div class="container">
    <div id="page-input" class="page">
        <div class="date-label" id="dateDisplayInput" style="color:#aaa; font-size:14px; margin-bottom:5px;">...</div>
        <h2>ä»Šæ—¥é‹å‹¢è¨ºæ–·</h2>
        <div class="input-group"><label class="label-text">ä½ çš„å¤§å</label><input type="text" id="userName" placeholder="è«‹è¼¸å…¥å§“å" maxlength="10"></div>
        <div class="input-group"><label class="label-text" style="color:#6c5ce7;">å°è±¡å§“å (é¸å¡«)</label>
            <div class="relation-switch"><div class="relation-option"><input type="radio" id="rel-love" name="relation" value="love" checked><label for="rel-love" class="love">ğŸ’˜ ç®—å§»ç·£ (æ’©)</label></div><div class="relation-option"><input type="radio" id="rel-hate" name="relation" value="hate"><label for="rel-hate" class="hate">ğŸ’£ ç®—å­½ç·£ (ç½µ)</label></div></div>
            <div class="input-row" style="margin-top:10px;"><input type="text" id="targetName" placeholder="è¼¸å…¥æƒ³ç®—çš„äºº..." maxlength="10"></div>
        </div>
        <div class="input-group"><label class="label-text">ç›®å‰å¿ƒæƒ…</label><input type="text" id="userMood" placeholder="ä¾‹ï¼šå¾ˆç…©ã€æƒ³é›¢è·" maxlength="20"></div>
        <div class="input-group"><label class="label-text">å‡ºç”Ÿæ—¥æœŸ (ç®—å…«å­—)</label><div class="input-row"><input type="date" id="userBirthDate" value="1995-01-01"><input type="time" id="userBirthTime" value="12:00"></div></div>
        <button id="aiBtn" class="btn btn-fortune" onclick="startOfflineAnalysis()">ğŸ”® é–‹å§‹éˆé­‚åˆ†æ (å…è²»)</button> 
        <button class="btn btn-secondary" onclick="goToFortune()">ğŸ€„ æ–ä¸€æ–æ±‚ç±¤</button>
        <button class="btn btn-secondary" onclick="goToCalendar()">ğŸ“… æŸ¥çœ‹è¾²æ°‘æ›†</button>
        <div id="dbStatus" style="font-size:10px; color:#ccc; margin-top:5px; text-align:center;">è³‡æ–™åº«è¼‰å…¥ä¸­...</div>
    </div>

    <div id="page-result" class="page" style="background:transparent; box-shadow:none;">
        <div class="loading-overlay" id="aiLoading"><div class="spinner"></div><p style="margin-top:15px; color:#2c3e50; font-weight:bold;">ğŸ¥” å»¢å»¢è–¯æ­£åœ¨é€šéˆ...</p></div>
        
        <div class="result-card" id="captureArea">
            <div class="card-header"><div class="card-name"><span id="resName"></span><span class="zodiac-badge" id="resZodiacBadge"></span></div><div class="card-date" id="resDate"></div><div class="card-lunar" id="resLunar"></div></div>
            <img src="./potato.png" id="mascotImage" class="mascot-img" alt="Mascot" onerror="this.src='./potato.png';">
            <div class="main-word" id="resultWord">...</div><div class="mood-tag" id="resMoodTag">...</div>
            <div id="luckyDashboard"></div>
            <div class="advice-text" id="resultAdvice"></div> 
            <div class="footer-note">â˜… å»¢è©±è¾²æ°‘æ›† Nonsense Almanac â˜…</div>
        </div>

        <div class="unlock-area" id="unlockArea"><button class="btn-unlock-trigger" onclick="unlockVip()">ğŸ”“ è§£é– AI å¤©æ©Ÿè©³æ‰¹ (éœ€é€£ç·š)</button></div>

        <div class="vip-card" id="vipCard">
            <div class="vip-title">ğŸ‘‘ VIP å¤©æ©Ÿè©³æ‰¹</div>
            <p style="font-weight:bold; color:#f1c40f; margin:10px 0 5px 0;">ğŸ“Š ä»Šæ—¥æˆ°åŠ›æŒ‡æ•¸</p><div id="powerBars"></div>
            <p style="font-weight:bold; color:#f1c40f; margin:20px 0 5px 0;">âš¡ ä»Šæ—¥ä½œå¼Šä»£ç¢¼ (AI)</p>
            <div class="cheat-box"><div id="vipCheatSheet" class="cheat-text">éœ€è§£é–æ‰èƒ½è§€çœ‹...</div></div>
            <p style="font-weight:bold; color:#f1c40f; margin:15px 0 5px 0;">ğŸ”® å…«å­—å‘½ç›¤</p>
            <div class="bazi-grid"><div class="bazi-col"><div class="bazi-label">å¹´</div><div class="bazi-val" id="bazi-y"></div></div><div class="bazi-col"><div class="bazi-label">æœˆ</div><div class="bazi-val" id="bazi-m"></div></div><div class="bazi-col"><div class="bazi-label">æ—¥</div><div class="bazi-val" id="bazi-d"></div></div><div class="bazi-col"><div class="bazi-label">æ™‚</div><div class="bazi-val" id="bazi-h"></div></div></div>
            <p style="font-weight:bold; color:#f1c40f; margin:15px 0 5px 0;">ğŸ“œ AI äººç”Ÿè©•èª</p>
            <p id="vipLifeComment" style="margin-top:5px; font-size:13px; color:#bdc3c7; line-height:1.6;">éœ€è§£é–æ‰èƒ½è§€çœ‹...</p>
            <button class="btn-action" onclick="downloadImage('full')" style="margin-top:20px;">ğŸ“¸ ä¸‹è¼‰å®Œæ•´å¤©æ©Ÿåœ–</button>
        </div>

        <div id="normalButtons">
            <button class="btn btn-info" onclick="showDetails()">ğŸ“… ç•¶æ—¥è©³æƒ…</button>
            <button class="btn btn-ig" onclick="downloadImage('ig')">ğŸ“¸ ä¸‹è¼‰é™å‹•åœ– (ç™½å¡)</button>
            <button class="btn btn-secondary" onclick="resetApp()">ğŸ  å›é¦–é </button>
        </div>
    </div>

    <div id="paywall-modal">
        <div class="paywall-content">
            <button class="btn-close-pay" onclick="document.getElementById('paywall-modal').style.display='none'">Ã—</button>
            <span class="pay-icon">ğŸš«</span>
            <div class="pay-title">ä»Šæ—¥ AI é¡åº¦å·²ç”¨å®Œ</div>
            <div class="pay-desc">æ‚¨çš„ AI æ·±åº¦åˆ†ææ¬¡æ•¸å·²é”ä¸Šé™ã€‚<br>åŸºæœ¬é‹å‹¢ (é›¢ç·šç‰ˆ) å¯ç„¡é™ä½¿ç”¨ã€‚</div>
            <button class="btn-ad" onclick="watchAd()">ğŸ“º çœ‹å»£å‘Šæ¢å¾© AI é€£ç·š</button>
            <button class="btn-buy" onclick="buyPro()">ğŸ‘‘ NT$99 çµ‚èº«ç„¡é™æš¢ç©</button>
        </div>
    </div>

    <div id="page-fortune" class="page"><h2 >è³½åšæ±‚ç±¤ç­’</h2><div class="fortune-shaker" id="shaker" onclick="drawFortune()">ğŸ€„</div><div id="shakingText" style="display:none; color:#d35400; font-weight:bold; margin-top:10px;">èª å¿ƒç¥ˆæ±‚ä¸­...</div><div class="poem-card" id="poemCard"><div class="poem-title" id="poemTitle"></div><div class="poem-content" id="poemContent"></div><div class="poem-note" id="poemNote"></div></div><button class="btn btn-secondary" style="margin-top:30px;" onclick="resetApp()">ğŸ  å›é¦–é </button></div>
    <div id="page-calendar" class="page"><div class="cal-header"><button class="btn-secondary" style="width:auto; margin:0;" onclick="changeMonth(-1)">â—€</button><div style="font-weight:bold" id="calTitle"></div><button class="btn-secondary" style="width:auto; margin:0;" onclick="changeMonth(1)">â–¶</button></div><div class="cal-grid" id="calendarGrid"></div><button class="btn btn-secondary" style="margin-top:20px;" onclick="resetApp()">ğŸ  å›é¦–é </button></div>
    <div id="detail-modal"><div class="detail-content"><div style="text-align:center;font-weight:bold;color:#c0392b;margin-bottom:15px;">é»ƒæ›†è©³æƒ…</div><div class="detail-row"><span class="detail-label">æ—¥æœŸ</span><span class="detail-val" id="d-date"></span></div><div class="detail-row"><span class="detail-label">å¹²æ”¯</span><span class="detail-val" id="d-ganzhi"></span></div><div class="detail-row"><span class="detail-label">å®œ</span><span class="detail-val" id="d-yi" style="color:#d35400"></span></div><div class="detail-row"><span class="detail-label">å¿Œ</span><span class="detail-val" id="d-ji" style="color:#27ae60"></span></div><div class="detail-row"><span class="detail-label">æ²–ç…</span><span class="detail-val" id="d-chong"></span></div><div class="detail-row"><span class="detail-label">è²¡ç¥</span><span class="detail-val" id="d-wealth"></span></div><div class="close-btn" onclick="closeDetails()">é—œé–‰</div></div></div>
</div>

<script>
    // ===========================================
    // âš ï¸ å¡«å…¥ä½ çš„ GAS ç¶²å€ (xxxx è¨˜å¾—æ›æ‰)
    const GAS_URL = "https://script.google.com/macros/s/AKfycbyoa6WVL06HPmBn-UJrfIFKX5h3-DfTDl4iigFXSv8XGTaOz7_5ahwq5uzMDzOHejdK/exec"; 
    // âš ï¸ å¯†ç¢¼ (èˆ‡ GAS ç›¸åŒ)
    const APP_SECRET = "POTATO_APP_VIP_888";
    // ===========================================

    // é è¨­å‚™ç”¨è³‡æ–™åº« (é˜²æ­¢ GAS é€£ç·šå¤±æ•—æ™‚é–‹å¤©çª—)
    let textDatabase = {
        self: { openings:["çœ‹ä½ é€™å‰¯æ­»æ¨£å­ï¼Œ"], bodies:{ default:["ä»Šå¤©é©åˆç•¶å»¢ç‰©ï¼Œ"] }, closings:["åŠ æ²¹å¥½å—ï¼Ÿ"] },
        love: { openings:["åˆ¥åšå¤¢äº†ï¼Œ"], bodies:{ default:["æ²’äººæ„›ä½ ï¼Œ"] }, closings:["ä¹–ä¹–å–®èº«å§ã€‚"] },
        hate: { openings:["ä»–ä»Šå¤©é‹æ°£ä¸éŒ¯ï¼Œ"], bodies:{ default:["å¿ä¸€æ™‚é¢¨å¹³æµªéœï¼Œ"] }, closings:["çœ‹é–‹é»ã€‚"] }
    };
    
    // å¿ƒæƒ…å­—å…¸ (é è¨­ç©ºï¼Œç­‰å¾…é›²ç«¯ä¸‹è¼‰)
    let moodDictionary = {};

    let currentDate = new Date();
    let calendarViewDate = new Date();
    let isProcessing = false;
    let isVipUser = localStorage.getItem('potato_is_vip') === 'true';

    // æ“´å……ç‰ˆ imgMap (å¿ƒæƒ…å­—å°æ‡‰åˆ°ç¾æœ‰åœ–)
    const imgMap = {
        "default": "./potato.png",
        "è¡": "./potato_charge.png", "charge": "./potato_charge.png",
        "æ’©": "./potato_flirt.png", "flirt": "./potato_flirt.png",
        "æª": "./potato_party.png", "party": "./potato_party.png",
        "é‚„": "./potato_pray.png", "pray": "./potato_pray.png",
        "æºœ": "./potato_travel.png", "travel": "./potato_travel.png",
        "æ‹†": "./potato_break.png", "break": "./potato_break.png",
        "æ’": "./potato_heavy.png", "heavy": "./potato_heavy.png",
        "èºº": "./potato_sleep.png", "sleep": "./potato_sleep.png",
        "é¾œ": "./potato_turtle.png", "turtle": "./potato_turtle.png",
        "å†·": "./potato_freeze.png", "freeze": "./potato_freeze.png",
        "é›·": "./potato_shock.png", "shock": "./potato_shock.png",
        "å¡": "./potato_stuck.png", "stuck": "./potato_stuck.png",
        "åˆ¥": "./potato_stop.png", "stop": "./potato_stop.png",
        "é–ƒ": "./potato_dodge.png", "dodge": "./potato_dodge.png",
        "é¤“": "./potato_party.png",
        "è‚¥": "./potato_heavy.png",
        "çª®": "./potato_shock.png",
        "è‰²": "./potato_flirt.png",
        "æ®º": "./potato_charge.png",
        "ç´¯": "./potato_sleep.png",
        "å»¢": "./potato_turtle.png",
        "é€ƒ": "./potato_travel.png",
        "å“­": "./potato_freeze.png",
        "ç¬‘": "./potato_party.png",
        "å‘†": "./potato.png",
        "å¤¢": "./potato_sleep.png",
        "ç—…": "./potato_stuck.png",
        "é©š": "./potato_shock.png",
        "è³­": "./potato_rich.png"
    };

    const almanacRules = { "é–‹å¸‚": { word: "è¡", img: "charge" }, "äº¤æ˜“": { word: "è¡", img: "charge" }, "å…¥å®…": { word: "æª", img: "party" }, "çº³é‡‡": { word: "æª", img: "party" }, "å«å¨¶": { word: "æ’©", img: "flirt" }, "è¨‚ç›Ÿ": { word: "æ’©", img: "flirt" }, "ç¥­ç¥€": { word: "é‚„", img: "pray" }, "ç¥ˆç¦": { word: "é‚„", img: "pray" }, "å‡ºè¡Œ": { word: "æºœ", img: "travel" }, "æ—…éŠ": { word: "æºœ", img: "travel" }, "å‹•åœŸ": { word: "æ‹†", img: "break" }, "ç ´å±‹": { word: "æ‹†", img: "break" }, "è§£é™¤": { word: "æ‹†", img: "break" }, "å®‰åºŠ": { word: "èºº", img: "sleep" }, "ç§»å¾™": { word: "èºº", img: "sleep" }, "æ²»ç—…": { word: "æ’", img: "heavy" }, "å®‰è‘¬": { word: "å†·", img: "freeze" }, "default": { word: "é¾œ", img: "turtle" } };
    const badDayRules = { "å‡ºè¡Œ": { word: "å¡", img: "stuck" }, "å«å¨¶": { word: "å†·", img: "freeze" }, "é–‹å¸‚": { word: "é›·", img: "shock" }, "å‹•åœŸ": { word: "åˆ¥", img: "stop" }, "æœƒè¦ªå‹": { word: "é–ƒ", img: "dodge" } };
    const poems = [ { title: "å¤§å‰å»¢", content: "ä»Šæ—¥å®œèººä¸å®œå¿™<br>è€é—†é›»è©±è€³é‚Šæ—<br>è–ªæ°´å…¥å¸³æœ€é‡è¦<br>å…¶ä»–çš†æ˜¯å¤¢ä¸€å ´", note: "è§£æ›°ï¼šèººè‘—å°±å°äº†" }, { title: "ä¸­å‰æ‡¶", content: "å·¥ä½œå †å¾—åƒåº§å±±<br>ä¸å¦‚å…ˆå»çˆ¬æ•å±±<br>å¤¢è£¡ä»€éº¼éƒ½æœ‰å¾—<br>é†’ä¾†ç¹¼çºŒæ“ºçˆ›æ”¤", note: "è§£æ›°ï¼šé€ƒé¿é›–å¯æ¥ä½†æœ‰ç”¨" }, { title: "ä¸‹ä¸‹å¿™", content: "ä»Šæ—¥è¡°ç¥åœ¨é ­é ‚<br>åƒè¬ä¸è¦çœ‹æ†§æ†¬<br>è‹¥æ˜¯ç¡¬è¦å‡ºé–€å»<br>è¨˜å¾—å¸¶æŠŠé˜²èº«é¤…", note: "è§£æ›°ï¼šä¹–ä¹–å¾…åœ¨å®¶" }, { title: "æœ«å‰é¤“", content: "äº”è‡Ÿå»Ÿè£¡é¬§ç©ºåŸ<br>æ¸›è‚¥è¨ˆç•«è¬ä¸èƒ½<br>çç å¥¶èŒ¶ä¾†ä¸€æ¯<br>å¿«æ¨‚ä¼¼ç¥ä»™ä¸‹å¡µ", note: "è§£æ›°ï¼šåƒé£½å†èªª" } ]; 
    const luckyColors = ["#e74c3c|ç†±æƒ…ç´…", "#3498db|æ†‚é¬±è—", "#f1c40f|ç™¼è²¡é»ƒ", "#2ecc71|éŸ­èœç¶ ", "#9b59b6|åŸºæƒ…ç´«", "#34495e|åŠ ç­é»‘", "#95a5a6|æ°´æ³¥ç°", "#e67e22|éå‹æ©˜"];
    const luckyDirections = ["æ±æ–¹", "è¥¿æ–¹", "å—æ–¹", "åŒ—æ–¹", "æ±åŒ—", "æ±å—", "è¥¿åŒ—", "è¥¿å—", "åºŠä¸Š", "å…¬å¸å¤–"];

    function s2t(text) { if(!text) return ""; return text.replace(/é¾™/g, "é¾").replace(/é©¬/g, "é¦¬").replace(/é¸¡/g, "é›").replace(/çŒª/g, "è±¬").replace(/ç¾Š/g, "ç¾Š").replace(/å†²/g, "æ²–").replace(/å†/g, "æ›†").replace(/ä¸‘/g, "ä¸‘").replace(/å†¬/g, "å†¬").replace(/è…Š/g, "è‡˜").replace(/é˜³/g, "é™½").replace(/é˜´/g, "é™°").replace(/ç¶/g, "ç¶").replace(/é—¨/g, "é–€").replace(/æˆ·/g, "æˆ¶"); }
    function loadUserData() { const savedName = localStorage.getItem('potato_userName'); const savedBirthDate = localStorage.getItem('potato_birthDate'); const savedBirthTime = localStorage.getItem('potato_birthTime'); const savedTarget = localStorage.getItem('potato_targetName'); if (savedName) document.getElementById('userName').value = savedName; if (savedBirthDate) document.getElementById('userBirthDate').value = savedBirthDate; if (savedBirthTime) document.getElementById('userBirthTime').value = savedBirthTime; if (savedTarget) document.getElementById('targetName').value = savedTarget; }
    function saveUserData() { localStorage.setItem('potato_userName', document.getElementById('userName').value); localStorage.setItem('potato_birthDate', document.getElementById('userBirthDate').value); localStorage.setItem('potato_birthTime', document.getElementById('userBirthTime').value); localStorage.setItem('potato_targetName', document.getElementById('targetName').value); }
    function getSeededRandom(seed) { let h = 0xdeadbeef; for(let i = 0; i < seed.length; i++) h = Math.imul(h ^ seed.charCodeAt(i), 2654435761); return ((h ^ h >>> 16) >>> 0) / 4294967296; }
    function calculateDailyLuck(date, zodiac) {
        const seed = `${date.getFullYear()}${date.getMonth()}${date.getDate()}-${zodiac}`;
        const rand = getSeededRandom(seed);
        const luckyNum = Math.floor(rand * 10);
        const colorIndex = Math.floor((rand * 100) % luckyColors.length);
        const [colorHex, colorName] = luckyColors[colorIndex].split('|');
        const hour = 9 + Math.floor((rand * 1000) % 10);
        const luckyTime = `${hour}:00 - ${hour+1}:00`;
        const dirIndex = Math.floor((rand * 50) % luckyDirections.length);
        const direction = luckyDirections[dirIndex];
        const scores = { wealth: Math.floor(getSeededRandom(seed+"w")*60+40), love: Math.floor(getSeededRandom(seed+"l")*100), work: Math.floor(getSeededRandom(seed+"wk")*100), health: Math.floor(getSeededRandom(seed+"h")*40+60), luck: Math.floor(getSeededRandom(seed+"lk")*100) };
        return { luckyNum, colorName, colorHex, luckyTime, direction, scores };
    }

    // åˆ†æå¿ƒæƒ…é—œéµå­— (è®€å–é›²ç«¯å­—å…¸)
    function analyzeMoodToKeyword(userMood) {
        if (!userMood || !moodDictionary) return null;
        for (let dbKey in moodDictionary) {
            const keywords = moodDictionary[dbKey];
            if (Array.isArray(keywords)) {
                for (let word of keywords) {
                    if (userMood.includes(word)) return dbKey;
                }
            }
        }
        return null;
    }

    // æ›´æ–°è³‡æ–™åº«
    async function updateTextDatabase() {
        const localDB = localStorage.getItem('potato_text_db');
        const lastUpdate = localStorage.getItem('potato_db_time');
        const now = new Date().getTime();
        let data = null;

        // 1å°æ™‚å¿«å–
        if (localDB && lastUpdate && (now - lastUpdate < 3600000)) {
            data = JSON.parse(localDB);
            document.getElementById('dbStatus').innerText = "è³‡æ–™åº«: æœ¬åœ°";
        } else {
            try {
                const response = await fetch(GAS_URL);
                if (!response.ok) throw new Error("Network error");
                data = await response.json();
                localStorage.setItem('potato_text_db', JSON.stringify(data));
                localStorage.setItem('potato_db_time', now);
                document.getElementById('dbStatus').innerText = "è³‡æ–™åº«: é›²ç«¯æœ€æ–°";
            } catch (e) {
                console.warn("âš ï¸", e);
                if (localDB) data = JSON.parse(localDB);
                document.getElementById('dbStatus').innerText = "è³‡æ–™åº«: é›¢ç·šæ¨¡å¼";
            }
        }

        if (data) {
            textDatabase = data;
            if (data.config) moodDictionary = data.config;
        }
    }

    function init() { 
        updateDateDisplay(); 
        loadUserData(); 
        updateTextDatabase(); 
    }

    // ä¸»ç¨‹å¼ï¼šé›¢ç·šåˆ†æ (Hybrid Mode)
    function startOfflineAnalysis() {
        saveUserData();
        showPage('page-result');
        document.getElementById('aiLoading').style.display = 'none';
        document.getElementById('vipCard').style.display = 'none';
        document.getElementById('unlockArea').style.display = 'block';

        const name = document.getElementById('userName').value.trim() || "å–„ç”·ä¿¡å¥³";
        const targetName = document.getElementById('targetName').value.trim();
        const mood = document.getElementById('userMood').value.trim() || "";
        const birthDateStr = document.getElementById('userBirthDate').value;
        const birthTimeStr = document.getElementById('userBirthTime').value;
        const birthDate = new Date(birthDateStr);
        const zodiac = getZodiacSign(birthDate);
        const relationType = document.querySelector('input[name="relation"]:checked').value;

        const destinySeed = `${currentDate.toDateString()}_${name}_${targetName}_${birthDateStr}`;

        // è¾²æ°‘æ›† (æ±ºå®šå¤§å­—)
        const lunar = Solar.fromDate(currentDate).getLunar();
        let themeData = almanacRules["default"];
        const yiList = lunar.getDayYi();
        for(let act of yiList) { if(almanacRules[act]) { themeData = almanacRules[act]; break; } }
        if (!themeData || themeData === almanacRules["default"]) { const jiList = lunar.getDayJi(); for(let act of jiList) { if(badDayRules[act]) { themeData = badDayRules[act]; break; } } }
        if (!themeData) themeData = almanacRules["default"];

        const luck = calculateDailyLuck(currentDate, zodiac);
        const bazi = Solar.fromYmdHms(parseInt(birthDateStr.split('-')[0]), parseInt(birthDateStr.split('-')[1]), parseInt(birthDateStr.split('-')[2]), parseInt(birthTimeStr.split(':')[0]), 0, 0).getLunar().getEightChar();

        // è¦–è¦ºï¼šå¼·åˆ¶è·Ÿéš¨è¾²æ°‘æ›†
        document.getElementById('resultWord').innerText = themeData.word;
        document.getElementById('mascotImage').src = imgMap[themeData.img] || imgMap["default"];

        document.getElementById('resName').innerText = targetName ? `${name} âš”ï¸ ${targetName}` : `${name} çš„é‹å‹¢`;
        document.getElementById('resZodiacBadge').innerText = zodiac;
        document.getElementById('resDate').innerText = `${currentDate.getFullYear()}.${currentDate.getMonth()+1}.${currentDate.getDate()}`;
        document.getElementById('resLunar').innerText = `è¾²æ›† ${lunar.getMonthInChinese()}æœˆ${lunar.getDayInChinese()}`;
        document.getElementById('resMoodTag').innerText = "å¿ƒæƒ…ï¼š" + (mood || "...");

        // æ–‡æ¡ˆï¼šå„ªå…ˆçœ‹å¿ƒæƒ…
        let finalKeyword = analyzeMoodToKeyword(mood);
        if (!finalKeyword) finalKeyword = themeData.word;

        let dbMode = 'self';
        if (targetName) dbMode = (relationType === 'love') ? 'love' : 'hate';
        
        const db = textDatabase[dbMode] || textDatabase.self;
        const openList = db.openings || ["å‘½é‹å¤šèˆ›ï¼Œ"];
        const open = openList[Math.floor(getSeededRandom(destinySeed + "open") * openList.length)];
        
        const bodyMap = db.bodies || {};
        let bodyList = bodyMap[finalKeyword] || bodyMap["default"] || Object.values(bodyMap)[0];
        if (!bodyList || bodyList.length === 0) bodyList = ["ç„¡è©±å¯èªªï¼Œ"];
        const body = bodyList[Math.floor(getSeededRandom(destinySeed + "body") * bodyList.length)];
        
        const closeList = db.closings || ["å¥½è‡ªç‚ºä¹‹ã€‚"];
        const close = closeList[Math.floor(getSeededRandom(destinySeed + "close") * closeList.length)];

        document.getElementById('resultAdvice').innerText = open + body + close;

        // åœ–è¡¨èˆ‡å…«å­—
        const luckyHTML = `<div class="lucky-dash"><div class="lucky-item"><div class="lucky-label">å¹¸é‹è‰²</div><div class="lucky-val" style="color:${luck.colorHex}">${luck.colorName}</div></div><div class="lucky-item"><div class="lucky-label">å¹¸é‹æ•¸</div><div class="lucky-val">${luck.luckyNum}</div></div><div class="lucky-item"><div class="lucky-label">å‰æ™‚</div><div class="lucky-val">${luck.luckyTime}</div></div><div class="lucky-item"><div class="lucky-label">å‰ä½</div><div class="lucky-val">${luck.direction}</div></div></div>`;
        document.getElementById('luckyDashboard').innerHTML = luckyHTML;

        const categories = [{id: 'wealth', label: 'ğŸ’° è²¡é‹'}, {id: 'love', label: 'ğŸ‘ æ¡ƒèŠ±'}, {id: 'work', label: 'ğŸ’¼ ç¤¾ç•œ'}, {id: 'health', label: 'ğŸ”‹ å¥åº·'}, {id: 'luck', label: 'ğŸŒŸ è²´äºº'}];
        let barsHTML = "";
        categories.forEach(cat => {
            const score = luck.scores[cat.id];
            barsHTML += `<div class="power-bar-container"><div class="power-label"><span>${cat.label}</span><span class="score-val">${score}</span></div><div class="progress-bg"><div class="progress-fill" style="width:${score}%"></div></div></div>`;
        });
        document.getElementById('powerBars').innerHTML = barsHTML;

        document.getElementById('bazi-y').innerText = s2t(bazi.getYear());
        document.getElementById('bazi-m').innerText = s2t(bazi.getMonth());
        document.getElementById('bazi-d').innerText = s2t(bazi.getDay());
        document.getElementById('bazi-h').innerText = s2t(bazi.getTime());
    }

    function unlockVip(){
        if (!isVipUser) {
            const today = new Date().toDateString();
            const usageData = JSON.parse(localStorage.getItem('potato_ai_usage') || '{}');
            if (usageData.date !== today) { usageData.date = today; usageData.count = 0; }
            if (usageData.count >= 1) { document.getElementById('paywall-modal').style.display = 'flex'; return; }
        }
        if(confirm("ã€æ¨¡æ“¬ä»˜è²»/å»£å‘Šã€‘è§£é– AI æ·±åº¦åˆ†æï¼Ÿ")) {
            document.getElementById('unlockArea').style.display = 'none';
            document.getElementById('vipCard').style.display = 'block';
            document.getElementById('vipCard').scrollIntoView({behavior:'smooth', block:'start'});
            callCloudAI(); 
        }
    }

    async function callCloudAI() {
        if (isProcessing) return;
        isProcessing = true;
        document.getElementById('vipCheatSheet').innerText = "AI æ­£åœ¨æ€è€ƒ...";
        document.getElementById('vipLifeComment').innerText = "AI æ­£åœ¨é€£ç·š...";

        const name = document.getElementById('userName').value;
        const targetName = document.getElementById('targetName').value;
        const relationType = document.querySelector('input[name="relation"]:checked').value;
        const mood = document.getElementById('userMood').value;
        const birthDateStr = document.getElementById('userBirthDate').value;
        const birthTimeStr = document.getElementById('userBirthTime').value;
        
        const cacheKey = `potato_ai_${birthDateStr}_${currentDate.toDateString()}_${name}`;
        const cachedData = localStorage.getItem(cacheKey);

        if (cachedData) {
            fillVipData(JSON.parse(cachedData));
            isProcessing = false;
            return;
        }

        const bazi = Solar.fromYmdHms(parseInt(birthDateStr.split('-')[0]), parseInt(birthDateStr.split('-')[1]), parseInt(birthDateStr.split('-')[2]), parseInt(birthTimeStr.split(':')[0]), 0, 0).getLunar().getEightChar();
        let task1Prompt = targetName 
            ? (relationType === "love" ? `ä½¿ç”¨è€… ${name} æƒ³å•èˆ‡å°è±¡ ${targetName} çš„ã€æˆ€æ„›å§»ç·£ã€‘ã€‚è«‹åˆ¤æ–·ä»Šå¤©é©åˆå‘Šç™½ã€ç´„æœƒé‚„æ˜¯ä¿æŒè·é›¢ï¼Ÿ(èªæ°£æ›–æ˜§æ’©äºº)` : `ä½¿ç”¨è€… ${name} æƒ³å•èˆ‡å°è±¡ ${targetName} çš„ã€è·å ´/å­½ç·£/ä»‡äººé—œä¿‚ã€‘ã€‚è«‹åˆ¤æ–·ä»Šå¤©é©åˆå—†è²ã€é–‹æˆ°é‚„æ˜¯é–ƒèº²ï¼Ÿ(èªæ°£æ¯’èˆŒè…¹é»‘)`)
            : `è«‹è§£é‡‹ç‚ºä»€éº¼åœ¨ã€Œ${mood}ã€çš„å¿ƒæƒ…ä¸‹ï¼Œä»Šå¤©é©åˆåšä»€éº¼ã€‚(èªæ°£æ¯’èˆŒå¹½é»˜)`;

        const prompt = `
            ã€System: You are a Taiwanese fortune teller AI. Output ONLY in Traditional Chinese (Taiwan/TW).ã€‘
            å¿ƒæƒ…ï¼š${mood}ã€‚å…«å­—å¹´å‘½ï¼š${s2t(bazi.getYearNaYin())}ã€‚
            ä»»å‹™ 1 (Advice): ${task1Prompt} (50å­—å…§)
            ä»»å‹™ 2 (Cheat Sheet): çµ¦å‡º 3 å€‹å…·é«”çš„ã€ä»Šæ—¥ä½œå¼Šä»£ç¢¼ã€‘ï¼Œä¾‹å¦‚ã€Œå®œï¼šå–çå¥¶ã€ã€ã€Œå¿Œï¼šå›è€é—†è¨Šæ¯ã€ã€ã€Œå¹¸é‹ç‰©ï¼šç™¼ç¥¨ã€ã€‚(ç°¡çŸ­åˆ—é»)
            ä»»å‹™ 3 (Vip Life): é‡å°é€™å€‹å…«å­—å¹´å‘½çš„å¹½é»˜äººç”Ÿè©•èªã€‚
            è«‹å›å‚³ JSON: { "advice": "...", "vip_cheat_sheet": "...", "vip_life_comment": "..." }
        `;

        try {
            const response = await fetch(GAS_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain' }, 
                body: JSON.stringify({ prompt: prompt, secret: APP_SECRET })
            });

            if (!response.ok) throw new Error("GAS Error");
            const data = await response.json();
            if(data.error) throw new Error(JSON.stringify(data.error));

            let rawText = "";
            if(data.candidates && data.candidates[0].content){ rawText = data.candidates[0].content.parts[0].text; } 
            else { if (data.text) rawText = data.text; else rawText = JSON.stringify(data); }
            
            const jsonStr = rawText.replace(/```json/g, '').replace(/```/g, '').trim();
            let result = JSON.parse(jsonStr);

            localStorage.setItem(cacheKey, JSON.stringify(result));
            if (!isVipUser) incrementUsage();
            fillVipData(result);

        } catch (e) {
            console.warn("AI å¤±æ•—:", e);
            document.getElementById('vipCheatSheet').innerHTML = "AI é€£ç·šå¤±æ•—<br>è«‹æª¢æŸ¥ç¶²è·¯: " + e.message;
        } finally {
            isProcessing = false;
        }
    }

    function fillVipData(result) {
        if(result.advice) document.getElementById('resultAdvice').innerText = result.advice;
        let cheatText = result.vip_cheat_sheet;
        if (Array.isArray(cheatText)) cheatText = cheatText.join('<br>');
        if (typeof cheatText === 'string') cheatText = cheatText.replace(/\n/g, '<br>');
        document.getElementById('vipCheatSheet').innerHTML = cheatText;
        document.getElementById('vipLifeComment').innerText = result.vip_life_comment;
    }

    function incrementUsage() {
        const today = new Date().toDateString();
        const usageData = JSON.parse(localStorage.getItem('potato_ai_usage') || '{}');
        usageData.date = today;
        usageData.count = (usageData.count || 0) + 1;
        localStorage.setItem('potato_ai_usage', JSON.stringify(usageData));
    }

    function watchAd() {
        const btn = document.querySelector('.btn-ad');
        const originalText = btn.innerText;
        btn.innerText = "ğŸ“º å»£å‘Šæ’­æ”¾ä¸­... (3s)";
        btn.disabled = true;
        setTimeout(() => {
            alert("âœ… ç²å¾—å…è²» AI æ¬¡æ•¸ï¼");
            document.getElementById('paywall-modal').style.display = 'none';
            btn.innerText = originalText;
            btn.disabled = false;
            callCloudAI();
        }, 3000);
    }

    function buyPro() {
        if(confirm("ã€æ¨¡æ“¬ã€‘ç¢ºèªæ”¯ä»˜ NT$99 è³¼è²·çµ‚èº« VIPï¼Ÿ")) {
            isVipUser = true;
            localStorage.setItem('potato_is_vip', 'true');
            alert("ğŸ‰ å‡ç´šæˆåŠŸï¼");
            document.getElementById('paywall-modal').style.display = 'none';
            callCloudAI();
        }
    }

    function downloadImage(mode) {
        if (mode === 'ig') {
            html2canvas(document.getElementById('captureArea'), { scale: 2, backgroundColor: "#fffdf5" }).then(saveCanvas);
        } else {
            const wasHidden = document.getElementById('vipCard').style.display === 'none';
            if(wasHidden) document.getElementById('vipCard').style.display = 'block';
            const element = document.getElementById('page-result');
            html2canvas(element, { scale: 2, backgroundColor: "#f0f2f5" }).then(canvas => {
                saveCanvas(canvas);
                if(wasHidden) document.getElementById('vipCard').style.display = 'none';
            });
        }
    }
    function saveCanvas(canvas) {
        const link = document.createElement('a');
        link.download = `é‹å‹¢_${new Date().getTime()}.png`;
        link.href = canvas.toDataURL('image/png');
        link.click();
    }
    function getZodiacSign(d){const m=d.getMonth()+1;const dy=d.getDate();if((m==1&&dy>=20)||(m==2&&dy<=18))return"æ°´ç“¶åº§ â™’";if((m==2&&dy>=19)||(m==3&&dy<=20))return"é›™é­šåº§ â™“";if((m==3&&dy>=21)||(m==4&&dy<=19))return"ç‰¡ç¾Šåº§ â™ˆ";if((m==4&&dy>=20)||(m==5&&dy<=20))return"é‡‘ç‰›åº§ â™‰";if((m==5&&dy>=21)||(m==6&&dy<=21))return"é›™å­åº§ â™Š";if((m==6&&dy>=22)||(m==7&&dy<=22))return"å·¨èŸ¹åº§ â™‹";if((m==7&&dy>=23)||(m==8&&dy<=22))return"ç…å­åº§ â™Œ";if((m==8&&dy>=23)||(m==9&&dy<=22))return"è™•å¥³åº§ â™";if((m==9&&dy>=23)||(m==10&&dy<=23))return"å¤©ç§¤åº§ â™";if((m==10&&dy>=24)||(m==11&&dy<=22))return"å¤©è åº§ â™";if((m==11&&dy>=23)||(m==12&&dy<=21))return"å°„æ‰‹åº§ â™";return"æ‘©ç¾¯åº§ â™‘";}
    function showPage(pageId) { document.querySelectorAll('.page').forEach(el => el.style.display = 'none'); document.getElementById(pageId).style.display = 'block'; }
    function updateDateDisplay() { const d = new Date(); document.getElementById('dateDisplayInput').innerText = `${d.getFullYear()}/${d.getMonth()+1}/${d.getDate()}`; }
    function goToFortune(){showPage('page-fortune');document.getElementById('poemCard').style.display='none';document.getElementById('shaker').classList.remove('shaking');document.getElementById('shakingText').style.display='none';}
    function drawFortune(){const s=document.getElementById('shaker');s.classList.add('shaking');document.getElementById('shakingText').style.display='block';document.getElementById('poemCard').style.display='none';setTimeout(()=>{s.classList.remove('shaking');document.getElementById('shakingText').style.display='none';const r=poems[Math.floor(Math.random()*poems.length)];document.getElementById('poemTitle').innerText=r.title;document.getElementById('poemContent').innerHTML=r.content;document.getElementById('poemNote').innerText=r.note;document.getElementById('poemCard').style.display='block';},1500);}
    function goToCalendar(){showPage('page-calendar');renderCalendar();}
    function changeMonth(o){calendarViewDate.setMonth(calendarViewDate.getMonth()+o);renderCalendar();}
    function renderCalendar(){const g=document.getElementById('calendarGrid');g.innerHTML="";document.getElementById('calTitle').innerText=`${calendarViewDate.getFullYear()}å¹´ ${calendarViewDate.getMonth()+1}æœˆ`;['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'].forEach(w=>{const d=document.createElement('div');d.innerText=w;d.style.fontSize="12px";g.appendChild(d)});const y=calendarViewDate.getFullYear();const m=calendarViewDate.getMonth();const f=new Date(y,m,1);const l=new Date(y,m+1,0);for(let i=0;i<f.getDay();i++)g.appendChild(document.createElement('div'));for(let d=1;d<=l.getDate();d++){const c=document.createElement('div');c.className='cal-cell';c.innerText=d;if(new Date(y,m,d).toDateString()===new Date().toDateString())c.classList.add('is-today');c.onclick=()=>{currentDate=new Date(y,m,d);showDetails()};g.appendChild(c);}}
    function resetApp(){document.getElementById('userMood').value="";document.getElementById('targetName').value="";currentDate=new Date();calendarViewDate=new Date();updateDateDisplay();showPage('page-input');document.getElementById('detail-modal').style.display='none';}
    function showDetails(){document.getElementById('detail-modal').style.display='flex';try{const l=Solar.fromDate(currentDate).getLunar();const s=(f)=>{try{return f()}catch{return"-"}};document.getElementById('d-date').innerText=`${currentDate.getFullYear()}/${currentDate.getMonth()+1}/${currentDate.getDate()}`;document.getElementById('d-ganzhi').innerText=s2t(`${l.getYearInGanZhi()}å¹´ ${l.getMonthInGanZhi()}æœˆ ${l.getDayInGanZhi()}æ—¥`);document.getElementById('d-yi').innerText=s2t(s(()=>l.getDayYi()).join(',')||"-");document.getElementById('d-ji').innerText=s2t(s(()=>l.getDayJi()).join(',')||"-");document.getElementById('d-chong').innerText=s2t(`${l.getDayChongDesc()}`);document.getElementById('d-wealth').innerText=s2t(`${l.getPositionXi()} / ${l.getPositionCai()}`);}catch{}}
    function closeDetails(){document.getElementById('detail-modal').style.display='none';}

    init();
</script>

</body>
</html>